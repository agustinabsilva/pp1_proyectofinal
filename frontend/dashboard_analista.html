<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analista - AINABI</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="styleempleado.css" />
  <link rel="stylesheet" href="bienvenida.css" />
  <link rel="stylesheet" href="styleprofile.css" />
  <style>
    #tabla-container {
      overflow-x: auto; /* Permite el scroll horizontal si la tabla es muy ancha */
      max-width: 100%;  /* Asegura que el contenedor no se desborde de su padre (la card) */
    }
    #tabla-container table {
      font-size: 0.875rem; /* Reduce un poco el tamaño de la fuente de la tabla */
      width: 100%;       /* Hace que la tabla ocupe el ancho disponible en su contenedor (que ahora tiene scroll) */
    }
    #tabla-container th,
    #tabla-container td {
      padding: 0.5rem 0.75rem; /* Ajusta el padding de las celdas para que sean un poco más compactas */
      white-space: nowrap;   /* Evita que el texto largo en las celdas se divida en múltiples líneas,
                                 lo cual funciona bien con el scroll horizontal del contenedor.
                                 Si prefieres que el texto se divida, puedes comentar o quitar esta línea. */
    }

    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .stat-card {
      background: rgba(230, 226, 195, 0.3);
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
      border: 1px solid #e6e2c3;
      transition: all 0.3s ease;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #4d6a3a;
      margin-bottom: 0.75rem;
    }

    .stat-label {
      color: #4d6a3a;
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.3;
    }

    .btn-ainabi {
      background-color: #4d6a3a;
      color: #fff;
      border-radius: 12px;
      border: none;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-ainabi:hover {
      background-color: #3a5129;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .custom-popup-class {
      border: 2px solid #e6e2c3;
      border-radius: 24px;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      position: fixed;
      top: 50% !important;
      left: calc(50% + 125px) !important; /* Ajustado para mover más a la izquierda */
      transform: translate(-50%, -50%) !important;
      max-width: 500px !important;
      width: 90% !important;
    }
    .custom-title-class {
      color: #4d6a3a !important;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      margin-bottom: 0 !important;
      padding: 1em 1em 0.5em !important;
    }
    .custom-confirm-button {
      padding: 8px 32px !important;
      border-radius: 12px !important;
      font-family: 'Poppins', sans-serif !important;
    }
    .swal2-html-container {
      margin: 0 !important;
      padding: 0 10px 20px !important;
    }
    /* Ajustar el contenedor principal de SweetAlert2 */
    .swal2-container {
      align-items: center !important;
      padding: 0 !important;
    }
    /* Asegurar que el popup mantenga su tamaño */
    .swal2-popup {
      margin: 0 !important;
    }
    
    @media (max-width: 768px) {
      .custom-popup-class {
        left: 50% !important; /* Reset en móvil donde el sidebar no ocupa espacio */
      }
    }
    
    .profile-hover:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 4px 15px rgba(183, 215, 194, 0.5);
    }
  </style>
  <!-- Firebase y lógica de app -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <!-- Fin Firebase -->
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar p-4 d-flex flex-column justify-content-between">
      <div>
        <h2 class="logo mb-4">🌿 AINABI</h2>
        <nav class="nav flex-column">
          <a href="#" class="nav-link" id="nav-prediccion">
            <i class="fas fa-chart-line me-2"></i>Predicción de Rendimiento
          </a>
          <a href="#" class="nav-link" id="nav-rotacion">
            <i class="fas fa-exchange-alt me-2"></i>Detección de Rotación
          </a>
          <a href="#" class="nav-link" id="nav-perfil">
            <i class="fas fa-user me-2"></i>Mi Perfil
          </a>
        </nav>
      </div>
      <div class="mt-4">
        <a href="#" class="nav-link text-danger" id="btn-logout">
          <i class="fas fa-sign-out-alt me-2"></i>Salir
        </a>
      </div>
    </aside>

    <!-- Sección principal -->
    <main class="flex-grow-1 p-4">
      <div id="prediccion-section">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="card shadow-sm p-4" style="background: #fdfbe8; border-radius: 24px; border: 2px solid #e6e2c3; max-width: 600px; width: 100%;">
            <div class="text-center mb-3">
              <h4 class="mb-3" style="color: #4d6a3a;">Predicción de Rendimiento (Regresión Lineal)</h4>
              <!-- Subir CSV de entrenamiento -->
              <input type="file" id="input-csv-entrenamiento" accept=".csv" class="form-control mb-2" />
              <button id="btn-entrenar-regresion" class="btn btn-ainabi mb-2">Entrenar modelo</button>
              <!-- Subir CSV de predicción -->
              <input type="file" id="input-csv-prediccion" accept=".csv" class="form-control mb-2" />
              <button id="btn-predecir-regresion" class="btn btn-ainabi mb-2">Predecir</button>
              <div id="regresion-resultados" class="mt-3" style="white-space: pre-wrap; color: #4d6a3a;"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="rotacion-section" style="display:none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="card shadow-sm p-4" style="background: #fdfbe8; border-radius: 24px; border: 2px solid #e6e2c3; max-width: 600px; width: 100%;">
            <div class="text-center mb-3">
              <h4 class="mb-3" style="color: #4d6a3a;">Probabilidad de Rotación (K-Means)</h4>
              <button id="btn-ejecutar-kmeans-real" class="btn btn-ainabi mb-2">Ejecutar K-Means</button>
              <div id="kmeans-resultados" class="mt-3" style="white-space: pre-wrap; color: #4d6a3a;"></div>
              <div id="tabla-container" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="perfil-section" style="display:none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="card shadow-sm p-4" style="background: #fdfbe8; border-radius: 24px; border: 2px solid #e6e2c3; max-width: 400px; width: 100%;">
            <div class="text-center mb-3">
              <h2 style="color: #4d6a3a; font-weight: 700; letter-spacing: 2px; margin-bottom: 20px;">🌿AINABI🌿</h2>
              <div style="display: flex; justify-content: center;">
                <div style="background: #e6e2c3; border-radius: 50%; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; box-shadow: 0 2px 8px #b7d7c2;">
                  <img src="./assets/profilephoto.png" 
                       alt="Foto de perfil" 
                       style="width: 120px; 
                              height: 120px; 
                              border-radius: 50%; 
                              object-fit: cover;
                              transition: all 0.3s ease;
                              transform-origin: center;
                              cursor: pointer;"
                       class="profile-hover"
                       data-bs-toggle="tooltip" 
                       data-bs-placement="right" 
                       data-bs-custom-class="custom-tooltip"
                       title="¡Hola! 🌿">
                </div>
              </div>
              <h3 id="user-nombre" style="color: #4d6a3a; font-weight: 600; margin-bottom: 18px; margin-top: 10px;">Nombre Apellido</h3>
            </div>
            <div style="font-size: 1.1rem; color: #4d6a3a;">
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Rol:</span>
                <span id="user-rol" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Área:</span>
                <span id="user-area" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Jerarquía:</span>
                <span id="user-jerarquia" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Email:</span>
                <span id="user-email" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-3">
                <span style="font-weight: 500;">Activo:</span>
                <span>
                  <span id="user-activo" style="background: #e6f5d0; color: #4d6a3a; border-radius: 16px; padding: 2px 16px; font-weight: 600; font-size: 1rem;">Activo</span>
                </span>
              </div>
            </div>
            <div class="text-center mt-3">
              <button id="btn-solicitar-cambio" class="btn btn-light border btn-ainabi" style="border-radius: 12px; border: 2px solid #e6e2c3;">Solicitar cambiar datos</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal para solicitar cambio de datos -->
  <div class="modal fade" id="modalCambioDatos" tabindex="-1" aria-labelledby="modalCambioDatosLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-centered">
      <div class="modal-content" style="background: #fdfbe8; border: 2px solid #e6e2c3; border-radius: 24px;">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-body">
          <div style="text-align: center;">
            <h5 class="modal-title" id="modalCambioDatosLabel" style="color: #4d6a3a; font-weight: 700; font-family: 'Poppins', sans-serif; margin: 20px 0 30px; font-size: 1.5rem;">
              Solicitud de cambio de datos 
            </h5>
            <div style="display: flex; justify-content: center; margin-bottom: 30px;">
              <div style="position: relative; display: inline-block;">
                <img src="./assets/profilephoto.png" 
                     alt="Carpincho AINABI" 
                     style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; background: #e6e2c3; padding: 10px;"
                     class="profile-hover">
              </div>
            </div>
            <p style="color: #4d6a3a; margin-bottom: 30px; font-size: 1.2rem;">
              Completa los datos que deseas actualizar 
            </p>
            <form id="form-cambio-datos" style="flex: 1; display: flex; flex-direction: column;">
              <div class="form-container">
                <div class="mb-5">
                  <label for="nuevo-nombre" class="form-label" style="color: #4d6a3a; font-weight: 500; text-align: left; display: block; margin-bottom: 10px; font-size: 1.1rem;">
                    Nuevo nombre <span style="color: #b88b66;">*</span>
                  </label>
                  <input type="text" 
                         class="form-control" 
                         id="nuevo-nombre" 
                         required
                         style="border: 2px solid #e6e2c3; 
                                border-radius: 12px; 
                                background: #fff; 
                                padding: 12px 20px;
                                font-size: 1.1rem;">
                </div>
                <div class="mb-5">
                  <label for="nuevo-email" class="form-label" style="color: #4d6a3a; font-weight: 500; text-align: left; display: block; margin-bottom: 10px; font-size: 1.1rem;">
                    Nuevo email <span style="color: #b88b66;">*</span>
                  </label>
                  <input type="email" 
                         class="form-control" 
                         id="nuevo-email" 
                         required
                         style="border: 2px solid #e6e2c3; 
                                border-radius: 12px; 
                                background: #fff; 
                                padding: 12px 20px;
                                font-size: 1.1rem;"
                         oninput="validarEmail(this)">
                  <div id="email-error" style="color: #b88b66; font-size: 0.9rem; margin-top: 8px; display: none;">
                    Por favor, ingresa un email válido
                  </div>
                </div>
              </div>
              <div style="margin-top: auto; padding-bottom: 10px;">
                <small class="form-text" style="color: #b88b66; display: block; margin-bottom: 20px; font-size: 1rem;">
                  * Todos los campos son obligatorios
                </small>
                <button type="submit" 
                        class="btn btn-light border btn-ainabi" 
                        style="border-radius: 12px; 
                               border: 2px solid #e6e2c3; 
                               padding: 12px 50px; 
                               background: #4d6a3a; 
                               color: #fff; 
                               font-family: 'Poppins', sans-serif;
                               font-size: 1.1rem;">
                  Enviar solicitud
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
  <script src="env.js"></script>
  <script>
    // Inicializar Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Función para mostrar secciones
    function mostrarSeccion(seccionId) {
      document.querySelectorAll('main > div').forEach(div => div.style.display = 'none');
      document.getElementById(seccionId).style.display = 'block';
    }

    // Función para activar navegación
    function setActiveNav(navId) {
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('nav-activa'));
      document.getElementById(navId).classList.add('nav-activa');
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Navegación
      document.getElementById('nav-prediccion').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarSeccion('prediccion-section');
        setActiveNav('nav-prediccion');
      });

      document.getElementById('nav-rotacion').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarSeccion('rotacion-section');
        setActiveNav('nav-rotacion');
      });

      document.getElementById('nav-perfil').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarSeccion('perfil-section');
        setActiveNav('nav-perfil');
      });

      // Logout
      document.getElementById('btn-logout').addEventListener('click', async function(e) {
        e.preventDefault();
        try {
          await firebase.auth().signOut();
          window.location.href = './login.html';
        } catch (error) {
          console.error('Error al cerrar sesión:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo cerrar la sesión',
            confirmButtonColor: '#4d6a3a'
          });
        }
      });

      // Regresión Lineal (Predicción de Rendimiento)
      let csvDataEntrenamiento = null;
      let csvDataPrediccion = null;
      let modeloEntrenado = false;

      const inputCsvEntrenamiento = document.getElementById("input-csv-entrenamiento");
      if (inputCsvEntrenamiento) {
        inputCsvEntrenamiento.addEventListener("change", function(e) {
          csvDataEntrenamiento = e.target.files[0];
        });
      }

      const inputCsvPrediccion = document.getElementById("input-csv-prediccion");
      if (inputCsvPrediccion) {
        inputCsvPrediccion.addEventListener("change", function(e) {
          csvDataPrediccion = e.target.files[0];
        });
      }

      const btnEntrenar = document.getElementById("btn-entrenar-regresion");
      if (btnEntrenar) {
        btnEntrenar.addEventListener("click", async () => {
          const resultadosDiv = document.getElementById("regresion-resultados");
          resultadosDiv.textContent = "Entrenando modelo...";
          btnEntrenar.disabled = true;
          if (!csvDataEntrenamiento) {
            resultadosDiv.textContent = "Por favor, selecciona un archivo CSV de entrenamiento.";
            btnEntrenar.disabled = false;
            return;
          }
          const formData = new FormData();
          formData.append("file", csvDataEntrenamiento);
          try {
            const res = await fetch("https://azurepy.onrender.com/api/predict/performance_train", {
              method: "POST",
              body: formData
            });
            if (!res.ok) throw new Error("Error en la petición: " + res.statusText);
            const data = await res.json();
            resultadosDiv.textContent = "Modelo entrenado con éxito. Precisión: " + (data.r2_score || "N/A");
            modeloEntrenado = true;
          } catch (error) {
            console.error("Error al entrenar modelo:", error);
            resultadosDiv.textContent = "Error al entrenar el modelo. " + error.message;
          }
          btnEntrenar.disabled = false;
        });
      }

      const btnPredecir = document.getElementById("btn-predecir-regresion");
      if (btnPredecir) {
        btnPredecir.addEventListener("click", async () => {
          const resultadosDiv = document.getElementById("regresion-resultados");
          resultadosDiv.textContent = "Realizando predicción...";
          btnPredecir.disabled = true;
          if (!csvDataPrediccion) {
            resultadosDiv.textContent = "Por favor, selecciona un archivo CSV de predicción.";
            btnPredecir.disabled = false;
            return;
          }
          if (!modeloEntrenado) {
            resultadosDiv.textContent = "Primero debes entrenar el modelo.";
            btnPredecir.disabled = false;
            return;
          }
          const formData = new FormData();
          formData.append("file", csvDataPrediccion);
          try {
            const res = await fetch("https://azurepy.onrender.com/api/predict/future_performance", {
              method: "POST",
              body: formData
            });
            if (!res.ok) throw new Error("Error en la petición: " + res.statusText);
            const data = await res.json();
            resultadosDiv.textContent = JSON.stringify(data, null, 2);
          } catch (error) {
            console.error("Error al realizar predicción:", error);
            resultadosDiv.textContent = "Error al realizar la predicción. " + error.message;
          }
          btnPredecir.disabled = false;
        });
      }

      // K-Means (Probabilidad de Rotación)
      const btnKMeansReal = document.getElementById('btn-ejecutar-kmeans-real');
      if (btnKMeansReal) {
        btnKMeansReal.addEventListener('click', async () => {
          const resultadosDiv = document.getElementById('kmeans-resultados');
          const tablaContainerDiv = document.getElementById('tabla-container');

          resultadosDiv.textContent = "Ejecutando K-Means...";
          tablaContainerDiv.innerHTML = ""; // Limpiar tabla anterior

          try {
            const response = await fetch('https://testkmeans.onrender.com/kmeans', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
              if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                resultadosDiv.textContent = "K-Means ejecutado correctamente.";
                mostrarResultadosKMeans(data.data);
              } else {
                resultadosDiv.textContent = "K-Means ejecutado, pero no se recibieron datos válidos para la tabla.";
              }
            } else {
              let errorMessage = `Error HTTP ${response.status}: ${response.statusText}`;
              if (data && data.error) {
                errorMessage += ` - Mensaje del servidor: ${data.error}`;
              } else if (response.status === 405) {
                errorMessage += ` (El servidor no permite el método POST para esta URL)`;
              }
              resultadosDiv.textContent = errorMessage;
              console.error("Error del servidor K-Means:", errorMessage, data);
            }
          } catch (error) {
            console.error("Error en la solicitud K-Means:", error);
            resultadosDiv.textContent = "Error al realizar la solicitud K-Means. Revisa la consola del navegador para más detalles.";
          }
        });
      }

      function mostrarResultadosKMeans(data) {
        let tablaHTML = '<table class="table table-bordered"><thead><tr>';
        // Asegurarse de que hay datos y el primer elemento es un objeto para obtener las cabeceras
        if (data.length > 0 && typeof data[0] === 'object' && data[0] !== null) {
          for (const key in data[0]) {
            tablaHTML += `<th>${key}</th>`;
          }
        }
        tablaHTML += '</tr></thead><tbody>';

        data.forEach(row => {
          tablaHTML += '<tr>';
          // Asegurarse de que la fila es un objeto antes de iterar
          if (typeof row === 'object' && row !== null) {
            for (const key in row) {
              tablaHTML += `<td>${row[key]}</td>`;
            }
          }
          tablaHTML += '</tr>';
        });

        tablaHTML += '</tbody></table>';
        document.getElementById('tabla-container').innerHTML = tablaHTML;
      }

      // Funcionalidad para el botón "Solicitar cambiar datos"
      const btnSolicitarCambio = document.getElementById('btn-solicitar-cambio');
      if (btnSolicitarCambio) {
        btnSolicitarCambio.addEventListener('click', function() {
          const modal = new bootstrap.Modal(document.getElementById('modalCambioDatos'));
          modal.show();
        });
      }

      // Manejar el envío del formulario de cambio de datos
      const formCambio = document.getElementById('form-cambio-datos');
      if (formCambio) {
        formCambio.addEventListener('submit', async function(e) {
          e.preventDefault();
          const nuevoNombre = document.getElementById('nuevo-nombre').value;
          const nuevoEmail = document.getElementById('nuevo-email').value;

          try {
            const user = firebase.auth().currentUser;
            if (user) {
              // Verificar si el email ya existe en la base de datos
              const emailQuery = await firebase.firestore()
                .collection('users')
                .where('email', '==', nuevoEmail)
                .get();

              if (!emailQuery.empty) {
                const emailInput = document.getElementById('nuevo-email');
                const errorDiv = document.getElementById('email-error');
                emailInput.style.borderColor = '#b88b66';
                errorDiv.textContent = 'Este email ya está registrado';
                errorDiv.style.display = 'block';
                return;
              }

              // Obtener datos actuales del usuario
              const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
              let nombreActual = '';
              let emailActual = '';
              if (userDoc.exists) {
                const data = userDoc.data();
                nombreActual = data.nombre || '';
                emailActual = data.email || user.email || '';
              }

              // Si el email es el mismo que el actual
              if (nuevoEmail === emailActual) {
                const emailInput = document.getElementById('nuevo-email');
                const errorDiv = document.getElementById('email-error');
                emailInput.style.borderColor = '#b88b66';
                errorDiv.textContent = 'El nuevo email debe ser diferente al actual';
                errorDiv.style.display = 'block';
                return;
              }

              await firebase.firestore().collection('solicitudes_cambio_datos').add({
                uid: user.uid,
                nombre_actual: nombreActual,
                email_actual: emailActual,
                nombre_nuevo: nuevoNombre,
                email_nuevo: nuevoEmail,
                estado: "pendiente",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              });

              // Cerrar el modal
              bootstrap.Modal.getInstance(document.getElementById('modalCambioDatos')).hide();

              // Mostrar mensaje de éxito
              Swal.fire({
                title: '🌿 ¡Solicitud enviada! 🌿',
                html: `<div style="color: #4d6a3a; font-family: 'Poppins', sans-serif; text-align: center;">
                        <div style="display: flex; justify-content: center; margin: 20px 0;">
                          <div style="position: relative; display: inline-block;">
                            <img src="./assets/profilephoto.png" 
                                 alt="Carpincho AINABI" 
                                 style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; background: #e6e2c3; padding: 10px;"
                                 class="profile-hover">
                            <div style="position: absolute; bottom: 0; right: 0; background: #4d6a3a; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;">
                              <span style="color: #fff; font-size: 14px;">✓</span>
                            </div>
                          </div>
                        </div>
                        <div style="background: rgba(230, 226, 195, 0.3); border-radius: 16px; padding: 20px; margin: 15px auto; max-width: 300px;">
                          <p style="color: #4d6a3a; font-weight: 600; margin-bottom: 10px;">
                            Tu solicitud fue enviada al administrador
                          </p>
                          <p style="color: #4d6a3a; font-size: 0.95rem; margin: 0;">
                            De ser aceptada, te notificaremos por email
                          </p>
                        </div>
                      </div>`,
                showConfirmButton: true,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#4d6a3a',
                background: '#fdfbe8',
                customClass: {
                  popup: 'custom-popup-class',
                  title: 'custom-title-class',
                  confirmButton: 'custom-confirm-button'
                }
              });
              formCambio.reset();
            } else {
              Swal.fire({
                title: '🌿 Error 🌿',
                html: `<div style="color: #4d6a3a; font-family: 'Poppins', sans-serif; text-align: center;">
                        <div style="display: flex; justify-content: center; margin: 20px 0;">
                          <div style="position: relative; display: inline-block;">
                            <img src="./assets/profilephoto.png" 
                                 alt="Carpincho AINABI" 
                                 style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; background: #e6e2c3; padding: 10px;"
                                 class="profile-hover">
                          </div>
                        </div>
                        <div style="background: rgba(230, 226, 195, 0.3); border-radius: 16px; padding: 20px; margin: 15px auto; max-width: 300px;">
                          <p style="color: #4d6a3a; font-weight: 600; margin: 0;">
                            Debes estar logueado para enviar la solicitud
                          </p>
                        </div>
                      </div>`,
                showConfirmButton: true,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#4d6a3a',
                background: '#fdfbe8',
                customClass: {
                  popup: 'custom-popup-class',
                  title: 'custom-title-class',
                  confirmButton: 'custom-confirm-button'
                }
              });
            }
          } catch (err) {
            Swal.fire({
              title: '🌿 Error 🌿',
              html: `<div style="color: #4d6a3a; font-family: 'Poppins', sans-serif; text-align: center;">
                      <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <div style="position: relative; display: inline-block;">
                          <img src="./assets/profilephoto.png" 
                               alt="Carpincho AINABI" 
                               style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; background: #e6e2c3; padding: 10px;"
                               class="profile-hover">
                        </div>
                      </div>
                      <div style="background: rgba(230, 226, 195, 0.3); border-radius: 16px; padding: 20px; margin: 15px auto; max-width: 300px;">
                        <p style="color: #4d6a3a; font-weight: 600; margin: 0;">
                          No se pudo enviar la solicitud: ${err.message}
                        </p>
                      </div>
                    </div>`,
              showConfirmButton: true,
              confirmButtonText: 'Entendido',
              confirmButtonColor: '#4d6a3a',
              background: '#fdfbe8',
              customClass: {
                popup: 'custom-popup-class',
                title: 'custom-title-class',
                confirmButton: 'custom-confirm-button'
              }
            });
          }
        });
      }

      // Cargar datos del usuario logueado
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          try {
            const doc = await db.collection("users").doc(user.uid).get();
            if (doc.exists) {
              const datos = doc.data();
              
              // Actualizar campos del perfil
              document.getElementById('user-nombre').textContent = datos.nombre || "Sin nombre";
              document.getElementById('user-rol').textContent = datos.role || "Sin rol";
              document.getElementById('user-area').textContent = datos.area || "Sin área";
              document.getElementById('user-jerarquia').textContent = datos.jerarquia || "Sin jerarquía";
              document.getElementById('user-email').textContent = datos.email || user.email || "Sin email";
              
              // Estado activo
              if (typeof datos.activo !== "undefined") {
                document.getElementById('user-activo').textContent = datos.activo ? "Activo" : "Inactivo";
                document.getElementById('user-activo').style.background = datos.activo ? "#e6f5d0" : "#f5e6e6";
                document.getElementById('user-activo').style.color = datos.activo ? "#4d6a3a" : "#a94442";
              } else {
                document.getElementById('user-activo').textContent = "Sin dato";
                document.getElementById('user-activo').style.background = "#f5e6e6";
                document.getElementById('user-activo').style.color = "#a94442";
              }
            }
          } catch (error) {
            console.error('Error al obtener datos del usuario:', error);
            Swal.fire({
              title: 'Error',
              text: 'No se pudieron cargar los datos del perfil',
              icon: 'error',
              confirmButtonColor: '#4d6a3a'
            });
          }
        } else {
          console.log('No hay usuario autenticado');
          // No redirigir si ya estamos en la página de login
          if (!window.location.pathname.includes('login.html')) {
            window.location.href = './login.html';
          }
        }
      });
    });
  </script>
  
  <script>
    // Función para validar email
    function validarEmail(input) {
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
      const errorDiv = document.getElementById('email-error');
      const submitButton = document.querySelector('#form-cambio-datos button[type="submit"]');
      
      if (!emailRegex.test(input.value)) {
        input.style.borderColor = '#b88b66';
        errorDiv.style.display = 'block';
        submitButton.disabled = true;
      } else {
        input.style.borderColor = '#e6e2c3';
        errorDiv.style.display = 'none';
        submitButton.disabled = false;
      }
    }
  </script>
</body>
</html>