<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analista - AINABI</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="styleempleado.css" />
  <link rel="stylesheet" href="bienvenida.css" />
  <link rel="stylesheet" href="styleprofile.css" />
  <style>
    #tabla-container {
      overflow-x: auto; /* Permite el scroll horizontal si la tabla es muy ancha */
      max-width: 100%;  /* Asegura que el contenedor no se desborde de su padre (la card) */
    }
    #tabla-container table {
      font-size: 0.875rem; /* Reduce un poco el tamaño de la fuente de la tabla */
      width: 100%;       /* Hace que la tabla ocupe el ancho disponible en su contenedor (que ahora tiene scroll) */
    }
    #tabla-container th,
    #tabla-container td {
      padding: 0.5rem 0.75rem; /* Ajusta el padding de las celdas para que sean un poco más compactas */
      white-space: nowrap;   /* Evita que el texto largo en las celdas se divida en múltiples líneas,
                                 lo cual funciona bien con el scroll horizontal del contenedor.
                                 Si prefieres que el texto se divida, puedes comentar o quitar esta línea. */
    }

    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .stat-card {
      background: rgba(230, 226, 195, 0.3);
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
      border: 1px solid #e6e2c3;
      transition: all 0.3s ease;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #4d6a3a;
      margin-bottom: 0.75rem;
    }

    .stat-label {
      color: #4d6a3a;
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.3;
    }

    .btn-ainabi {
      background-color: #4d6a3a;
      color: #fff;
      border-radius: 12px;
      border: none;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-ainabi:hover {
      background-color: #3a5129;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .custom-popup-class {
      border: 2px solid #e6e2c3;
      border-radius: 24px;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      position: fixed;
      top: 50% !important;
      left: calc(50% + 125px) !important; /* Ajustado para mover más a la izquierda */
      transform: translate(-50%, -50%) !important;
      max-width: 500px !important;
      width: 90% !important;
    }
    .custom-title-class {
      color: #4d6a3a !important;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      margin-bottom: 0 !important;
      padding: 1em 1em 0.5em !important;
    }
    .custom-confirm-button {
      padding: 8px 32px !important;
      border-radius: 12px !important;
      font-family: 'Poppins', sans-serif !important;
    }
    .swal2-html-container {
      margin: 0 !important;
      padding: 0 10px 20px !important;
    }
    /* Ajustar el contenedor principal de SweetAlert2 */
    .swal2-container {
      align-items: center !important;
      padding: 0 !important;
    }
    /* Asegurar que el popup mantenga su tamaño */
    .swal2-popup {
      margin: 0 !important;
    }
    
    @media (max-width: 768px) {
      .custom-popup-class {
        left: 50% !important; /* Reset en móvil donde el sidebar no ocupa espacio */
      }
    }
    
    .profile-hover:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 4px 15px rgba(183, 215, 194, 0.5);
    }

    /* Estilos para la sección de entrenamiento IA */
    .section-card {
      background-color: rgba(244, 247, 235, 0.7);
      border-radius: 20px;
      border: 1px solid #e6e2c3;
      padding: 25px;
      margin-bottom: 20px;
    }

    .section-title {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1.3rem;
      color: #8b7e55;
      margin-bottom: 1.2rem;
    }

    .header-title {
      font-family: 'Caveat', cursive;
      font-weight: 600;
      font-size: 2.8rem;
      color: #8b7e55;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .header-subtitle {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #4d6a3a;
      text-align: center;
      margin-bottom: 2rem;
    }

    .form-check-input {
      width: 20px;
      height: 20px;
      margin-top: 0.2rem;
      border: 2px solid #e6e2c3;
    }

    .file-upload-btn {
      background-color: #f4f7eb;
      border: 1px solid #e6e2c3;
      border-radius: 15px;
      padding: 10px 20px;
      color: #4d6a3a;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-btn:hover {
      background-color: #e6e2c3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .file-name-display {
      background-color: #f4f7eb;
      border: 1px solid #e6e2c3;
      border-radius: 15px;
      padding: 10px 20px;
      color: #4d6a3a;
      font-weight: 500;
      margin-top: 10px;
      display: inline-block;
    }

    .table-container {
      margin-top: 15px;
      margin-bottom: 15px;
    }

    .preview-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 1px solid #e6e2c3;
      border-radius: 10px;
      overflow: hidden;
    }

    .preview-table th {
      background-color: #f4f7eb;
      color: #4d6a3a;
      font-weight: 600;
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #e6e2c3;
    }

    .preview-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #e6e2c3;
      color: #4d6a3a;
    }

    .warning-text {
      color: #b88b66;
      display: flex;
      align-items: center;
      margin-top: 10px;
    }

    .warning-text i {
      margin-right: 8px;
    }

    .dropdown-select {
      background-color: #f4f7eb;
      border: 1px solid #e6e2c3;
      border-radius: 15px;
      padding: 10px 20px;
      color: #4d6a3a;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234d6a3a' viewBox='0 0 16 16'><path d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/></svg>");
      background-repeat: no-repeat;
      background-position: calc(100% - 15px) center;
      padding-right: 35px;
    }

    .config-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .config-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      color: #4d6a3a;
    }

    .btn-train {
      background-color: #e6e2c3;
      border: none;
      border-radius: 20px;
      color: #4d6a3a;
      font-weight: 600;
      padding: 12px 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      float: right;
    }

    .btn-train:hover {
      background-color: #d9d5b8;
      transform: translateY(-2px);
    }

    .history-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
    }

    .history-table th,
    .history-table td {
      padding: 10px 15px;
      text-align: left;
      color: #4d6a3a;
    }

    .history-table th {
      font-weight: 600;
      border-bottom: 1px solid #e6e2c3;
    }

    .btn-use-model {
      background-color: #e6e2c3;
      border: none;
      border-radius: 15px;
      color: #4d6a3a;
      font-weight: 500;
      padding: 5px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-use-model:hover {
      background-color: #d9d5b8;
    }

    .hidden-file-input {
      display: none;
    }

    .main-container {
      background-color: #fdfbe8;
      border-radius: 24px;
      padding: 30px;
      border: 2px solid #e6e2c3;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }
  </style>
  <!-- Firebase y lógica de app -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
  <!-- Fin Firebase -->
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar p-4 d-flex flex-column justify-content-between">
      <div>
        <h2 class="logo mb-4">🌿 AINABI</h2>
        <nav class="nav flex-column">
          <a href="#" class="nav-link nav-activa" id="nav-entrenamiento-ia">
            <i class="fas fa-robot me-2"></i>Entrenamiento IA
          </a>
          <a href="#" class="nav-link" id="nav-predecir-rendimiento">
            <i class="fas fa-chart-line me-2"></i>Predecir Rendimiento
          </a>
          <a href="#" class="nav-link" id="nav-deteccion-rotacion">
            <i class="fas fa-user-slash me-2"></i>Detección de Rotación
          </a>
          <a href="#" class="nav-link" id="nav-perfil">
            <i class="fas fa-user me-2"></i>Mi Perfil
          </a>
        </nav>
      </div>
      <div class="mt-4">
        <a href="#" class="nav-link text-danger" id="btn-logout">
          <i class="fas fa-sign-out-alt me-2"></i>Salir
        </a>
      </div>
    </aside>

    <!-- Sección principal -->
    <main class="flex-grow-1 p-4">
      <div id="entrenamiento-ia-section">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="main-container" style="max-width: 1400px; width: 95%; background-color: #faf6e9; border-radius: 20px; border: 1px solid #e6e2c3; padding: 30px;">
            <!-- Encabezado -->
            <div class="text-center mb-4">
              <h1 style="font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 2.5rem; color: #527a5a; margin-bottom: 15px; letter-spacing: 1px;">✨ Entrenamiento de Modelos IA ✨</h1>
              <p style="font-family: 'Poppins', sans-serif; color: #4d6a3a; font-size: 1.1rem; margin-bottom: 25px;">
                Entrená un modelo de inteligencia artificial para predecir el rendimiento de los empleados.
              </p>
            </div>
            
            <!-- Contenedor principal -->
            <div style="background-color: #fff; border-radius: 15px; border: 1px solid #e6e2c3; padding: 25px; margin-bottom: 20px; overflow-x: visible; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)';" onmouseout="this.style.boxShadow='';">
              <!-- Sección de carga de dataset -->
              <h3 style="color: #527a5a; font-size: 1.3rem; margin-bottom: 20px; font-family: 'Montserrat', sans-serif; font-weight: 600; border-bottom: 1px solid #e6e2c3; padding-bottom: 8px;">Cargar Dataset de Entrenamiento</h3>
              
              <div class="mb-4">
                <input type="file" id="csvFile" accept=".csv" class="hidden-file-input">
                <label for="csvFile" style="background-color: #eaf8e6; border: 1px solid #e6e2c3; border-radius: 10px; padding: 12px 20px; color: #527a5a; display: block; cursor: pointer; text-align: center; width: 100%; transition: all 0.3s ease; font-family: 'Poppins', sans-serif;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';this.style.backgroundColor='#d9f0d0';" onmouseout="this.style.transform='';this.style.boxShadow='';this.style.backgroundColor='#eaf8e6';">
                  <i class="fas fa-check-circle me-2"></i> Seleccionar archivo
                </label>
              </div>
              
              <!-- Formato esperado del dataset -->
              <div style="background-color: #f8f4e5; border: 1px solid #e6e2c3; border-radius: 10px; padding: 12px 15px; margin-bottom: 25px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.05)';" onmouseout="this.style.boxShadow='';">
                <p style="color: #6b5b3d; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; font-family: 'Poppins', sans-serif;">
                  <i class="fas fa-info-circle me-2"></i> Formato esperado del dataset:
                </p>
                <div style="overflow-x: auto; max-width: 100%;">
                  <table style="width: 100%; min-width: 900px; table-layout: fixed; border-collapse: separate; border-spacing: 0; border: 1px solid #e6e2c3; border-radius: 6px; overflow: hidden; background-color: #fff;">
                    <thead>
                      <tr style="background-color: #f0e6c7;">
                        <th style="width: 9%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">nombre</th>
                        <th style="width: 7%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">area</th>
                        <th style="width: 8%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">jerarquia</th>
                        <th style="width: 7%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">puntaje</th>
                        <th style="width: 12%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">cantidad_proyectos</th>
                        <th style="width: 9%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">desempenio</th>
                        <th style="width: 12%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">personas_equipo</th>
                        <th style="width: 10%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">horas_extra</th>
                        <th style="width: 14%; padding: 10px 4px; text-align: center; color: #6b5b3d; border-right: 1px solid #e6e2c3; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">asistencia_puntualidad</th>
                        <th style="width: 12%; padding: 10px 4px; text-align: center; color: #6b5b3d; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">desempenio_futuro</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">texto</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">texto</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">texto</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">número</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">número</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">texto</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">número</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">número</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem; border-right: 1px solid #e6e2c3;">número</td>
                        <td style="padding: 8px; text-align: center; color: #8b7e55; font-size: 0.8rem;">número</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <p style="color: #8b7e55; font-size: 0.85rem; margin-top: 8px; margin-bottom: 0; font-family: 'Poppins', sans-serif; font-style: italic;">
                  El archivo CSV debe incluir todas estas columnas para que el modelo funcione correctamente.
                </p>
              </div>
              
              <!-- Botón de entrenamiento -->
              <button id="btnTrainModel" style="background-color: #eaf8e6; border: none; border-radius: 10px; color: #527a5a; font-weight: 600; padding: 12px; cursor: pointer; width: 100%; margin-top: 20px; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';this.style.backgroundColor='#d9f0d0';" onmouseout="this.style.transform='';this.style.boxShadow='';this.style.backgroundColor='#eaf8e6';">
                Entrenar modelo
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de Predecir Rendimiento -->
      <div id="predecir-rendimiento-section" style="display:none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="main-container" style="max-width: 1400px; width: 95%; background-color: #faf6e9; border-radius: 20px; border: 1px solid #e6e2c3; padding: 30px;">
            <!-- Encabezado -->
            <div class="text-center mb-4">
              <h1 style="font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 2.5rem; color: #527a5a; margin-bottom: 15px; letter-spacing: 1px;">✨ Predicción de Rendimiento ✨</h1>
              <p style="font-family: 'Poppins', sans-serif; color: #4d6a3a; font-size: 1.1rem; margin-bottom: 25px;">
                Utilizá el modelo entrenado para predecir el rendimiento futuro de los empleados.
              </p>
            </div>
            
            <!-- Contenedor principal -->
            <div style="background-color: #fff; border-radius: 15px; border: 1px solid #e6e2c3; padding: 25px; margin-bottom: 20px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)';" onmouseout="this.style.boxShadow='';">
              <h3 style="color: #527a5a; font-size: 1.3rem; margin-bottom: 20px; font-family: 'Montserrat', sans-serif; font-weight: 600; border-bottom: 1px solid #e6e2c3; padding-bottom: 8px;">Cargar Datos para Predicción</h3>
              
              <div class="mb-4">
                <input type="file" id="csvFilePredecir" accept=".csv" class="hidden-file-input">
                <label for="csvFilePredecir" style="background-color: #eaf8e6; border: 1px solid #e6e2c3; border-radius: 10px; padding: 12px 20px; color: #527a5a; display: block; cursor: pointer; text-align: center; width: 100%; transition: all 0.3s ease; font-family: 'Poppins', sans-serif;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';this.style.backgroundColor='#d9f0d0';" onmouseout="this.style.transform='';this.style.boxShadow='';this.style.backgroundColor='#eaf8e6';">
                  <i class="fas fa-upload me-2"></i> Seleccionar archivo de empleados
                </label>
              </div>
              
              <p style="color: #8b7e55; font-size: 0.9rem; margin-bottom: 20px; font-family: 'Poppins', sans-serif; font-style: italic;">
                <i class="fas fa-info-circle me-2"></i> Cargá un archivo CSV con los datos de los empleados para predecir su rendimiento futuro.
              </p>
              
              <div class="mb-3">
                <label style="color: #527a5a; font-weight: 500; margin-bottom: 10px;">Modelo a utilizar:</label>
                <select class="form-select" style="background-color: #eaf8e6; border: 1px solid #e6e2c3; border-radius: 10px; padding: 10px; color: #527a5a; transition: all 0.3s ease; font-family: 'Poppins', sans-serif;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
                  <option value="">Cargando modelos disponibles...</option>
                </select>
                <small style="display: block; color: #8b7e55; margin-top: 5px; font-style: italic;">
                  <i class="fas fa-info-circle me-1"></i>
                  Seleccione el archivo CSV de entrenamiento que desea utilizar como modelo
                </small>
              </div>
              
              <button id="btnPredecir" style="background-color: #eaf8e6; border: none; border-radius: 10px; color: #527a5a; font-weight: 600; padding: 12px; cursor: pointer; width: 100%; margin-top: 20px; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';this.style.backgroundColor='#d9f0d0';" onmouseout="this.style.transform='';this.style.boxShadow='';this.style.backgroundColor='#eaf8e6';">
                Realizar predicción
              </button>

              <!-- Contenedor para el historial de CSV -->
              <div id="csv-history-container" class="mt-4" style="background-color: #fff; border-radius: 15px; border: 1px solid #e6e2c3; padding: 20px; margin-top: 30px;">
                <!-- El contenido se cargará dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de Detección de Rotación -->
      <div id="deteccion-rotacion-section" style="display:none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="main-container" style="max-width: 1400px; width: 95%; background-color: #faf6e9; border-radius: 20px; border: 1px solid #e6e2c3; padding: 30px;">
            <!-- Encabezado -->
            <div class="text-center mb-4">
              <h1 style="font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 2.5rem; color: #527a5a; margin-bottom: 15px; letter-spacing: 1px;">✨ Detección de Rotación ✨</h1>
              <p style="font-family: 'Poppins', sans-serif; color: #4d6a3a; font-size: 1.1rem; margin-bottom: 25px;">
                Identificá empleados con alto riesgo de rotación para tomar acciones preventivas.
              </p>
            </div>
            
            <!-- Contenedor principal -->
            <div style="background-color: #fff; border-radius: 15px; border: 1px solid #e6e2c3; padding: 25px; margin-bottom: 20px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)';" onmouseout="this.style.boxShadow='';">
              <h3 style="color: #527a5a; font-size: 1.3rem; margin-bottom: 20px; font-family: 'Montserrat', sans-serif; font-weight: 600; border-bottom: 1px solid #e6e2c3; padding-bottom: 8px;">Análisis de Riesgo de Rotación</h3>
              
              <div class="mb-4">
                <input type="file" id="csvFileRotacion" accept=".csv" class="hidden-file-input">
                <label for="csvFileRotacion" style="background-color: #eaf8e6; border: 1px solid #e6e2c3; border-radius: 10px; padding: 12px 20px; color: #527a5a; display: block; cursor: pointer; text-align: center; width: 100%; transition: all 0.3s ease; font-family: 'Poppins', sans-serif;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';this.style.backgroundColor='#d9f0d0';" onmouseout="this.style.transform='';this.style.boxShadow='';this.style.backgroundColor='#eaf8e6';">
                  <i class="fas fa-upload me-2"></i> Seleccionar archivo de empleados
                </label>
              </div>
              
              <p style="color: #8b7e55; font-size: 0.9rem; margin-bottom: 20px; font-family: 'Poppins', sans-serif; font-style: italic;">
                <i class="fas fa-info-circle me-2"></i> Cargá un archivo CSV con los datos de los empleados para analizar su riesgo de rotación.
              </p>
              
              <div class="mb-3">
                <label style="color: #527a5a; font-weight: 500; margin-bottom: 10px;">Umbral de riesgo:</label>
                <select class="form-select" style="background-color: #eaf8e6; border: 1px solid #e6e2c3; border-radius: 10px; padding: 10px; color: #527a5a; transition: all 0.3s ease; font-family: 'Poppins', sans-serif;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
                  <option value="alto">Alto (>75%)</option>
                  <option value="medio" selected>Medio (>50%)</option>
                  <option value="bajo">Bajo (>25%)</option>
                </select>
              </div>
              
              <button id="btnDetectarRotacion" style="background-color: #eaf8e6; border: none; border-radius: 10px; color: #527a5a; font-weight: 600; padding: 12px; cursor: pointer; width: 100%; margin-top: 20px; transition: all 0.3s ease; font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)';this.style.backgroundColor='#d9f0d0';" onmouseout="this.style.transform='';this.style.boxShadow='';this.style.backgroundColor='#eaf8e6';">
                Analizar riesgo de rotación
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de Perfil -->
      <div id="perfil-section" style="display:none;">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
          <div class="card shadow-sm p-4" style="background: #fdfbe8; border-radius: 24px; border: 2px solid #e6e2c3; max-width: 400px; width: 100%;">
            <div class="text-center mb-3">
              <h2 style="color: #4d6a3a; font-weight: 700; letter-spacing: 2px; margin-bottom: 20px;">🌿AINABI🌿</h2>
              <div style="display: flex; justify-content: center;">
                <div style="background: #e6e2c3; border-radius: 50%; width: 140px; height: 140px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; box-shadow: 0 2px 8px #b7d7c2;">
                  <img src="./assets/profilephoto.png" 
                       alt="Foto de perfil" 
                       style="width: 120px; 
                              height: 120px; 
                              border-radius: 50%; 
                              object-fit: cover;
                              transition: all 0.3s ease;
                              transform-origin: center;
                              cursor: pointer;"
                       class="profile-hover"
                       data-bs-toggle="tooltip" 
                       data-bs-placement="right" 
                       data-bs-custom-class="custom-tooltip"
                       title="¡Hola! 🌿">
                </div>
              </div>
              <h3 id="user-nombre" style="color: #4d6a3a; font-weight: 600; margin-bottom: 18px; margin-top: 10px;">Nombre Apellido</h3>
            </div>
            <div style="font-size: 1.1rem; color: #4d6a3a;">
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Rol:</span>
                <span id="user-rol" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Área:</span>
                <span id="user-area" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Jerarquía:</span>
                <span id="user-jerarquia" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span style="font-weight: 500;">Email:</span>
                <span id="user-email" style="font-weight: 400;">Cargando...</span>
              </div>
              <div class="d-flex justify-content-between mb-3">
                <span style="font-weight: 500;">Activo:</span>
                <span>
                  <span id="user-activo" style="background: #e6f5d0; color: #4d6a3a; border-radius: 16px; padding: 2px 16px; font-weight: 600; font-size: 1rem;">Activo</span>
                </span>
              </div>
            </div>
            <div class="text-center mt-3">
              <button id="btn-solicitar-cambio" class="btn btn-light border btn-ainabi" style="border-radius: 12px; border: 2px solid #e6e2c3;">Solicitar cambiar datos</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
  <script src="env.js"></script>
  <script>
    // Inicializar Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', function() {
      // Variables para el modelo de regresión lineal
      let csvFile = null;
      let modeloEntrenado = false;

      // Función para leer y guardar CSV en Firebase
      async function saveCSVToFirebase(file, type) {
        const reader = new FileReader();
        
        reader.onload = async function(e) {
          const csvContent = e.target.result;
          const timestamp = new Date().toISOString();
          const userId = auth.currentUser.uid;
          
          try {
            const docRef = await db.collection("csv_files").add({
              content: csvContent,
              fileName: file.name,
              type: type, // 'training', 'prediction', 'rotation'
              uploadedAt: timestamp,
              userId: userId,
              fileSize: file.size
            });
            
            console.log("CSV guardado en Firebase con ID:", docRef.id);
            return docRef.id;
          } catch (error) {
            console.error("Error al guardar CSV:", error);
            throw error;
          }
        };
        
        reader.readAsText(file);
      }

      // Función para cargar historial de CSV
      async function loadCSVHistory(type) {
        try {
          const userId = auth.currentUser.uid;
          const snapshot = await db.collection("csv_files")
            .where("userId", "==", userId)
            .where("type", "==", type)
            .orderBy("uploadedAt", "desc")
            .get();
          
          const history = [];
          snapshot.forEach(doc => {
            history.push({
              id: doc.id,
              ...doc.data()
            });
          });
          
          return history;
        } catch (error) {
          console.error("Error al cargar historial:", error);
          throw error;
        }
      }

      // Función para reconstruir CSV desde Firebase
      async function reconstructCSV(fileId) {
        try {
          const doc = await db.collection("csv_files").doc(fileId).get();
          if (doc.exists) {
            const data = doc.data();
            return {
              content: data.content,
              fileName: data.fileName
            };
          }
          throw new Error("Archivo no encontrado");
        } catch (error) {
          console.error("Error al reconstruir CSV:", error);
          throw error;
        }
      }

      // Función para descargar CSV
      function downloadCSV(content, fileName) {
        const blob = new Blob([content], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      // Función para mostrar solo la sección seleccionada
      function mostrarSeccion(seccionId) {
        // Ocultar todas las secciones
        document.getElementById('entrenamiento-ia-section').style.display = 'none';
        document.getElementById('perfil-section').style.display = 'none';
        document.getElementById('predecir-rendimiento-section').style.display = 'none';
        document.getElementById('deteccion-rotacion-section').style.display = 'none';
        
        // Mostrar la sección seleccionada
        document.getElementById(seccionId).style.display = 'block';
      }

      // Cambia la clase activa en la barra lateral
      function setActiveNav(navId) {
        document.getElementById('nav-entrenamiento-ia').classList.remove('nav-activa');
        document.getElementById('nav-predecir-rendimiento').classList.remove('nav-activa');
        document.getElementById('nav-deteccion-rotacion').classList.remove('nav-activa');
        document.getElementById('nav-perfil').classList.remove('nav-activa');
        document.getElementById(navId).classList.add('nav-activa');
      }

      // Por defecto, mostrar la sección de entrenamiento IA
      mostrarSeccion('entrenamiento-ia-section');
      setActiveNav('nav-entrenamiento-ia');

      // Navegación entre secciones
      document.getElementById('nav-entrenamiento-ia').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarSeccion('entrenamiento-ia-section');
        setActiveNav('nav-entrenamiento-ia');
      });

      document.getElementById('nav-predecir-rendimiento').addEventListener('click', async function(e) {
        e.preventDefault();
        console.log("🎯 Click en nav-predecir-rendimiento");
        
        mostrarSeccion('predecir-rendimiento-section');
        setActiveNav('nav-predecir-rendimiento');
        
        console.log("🔄 Intentando cargar modelos...");
        try {
          await updateModelSelector();
          console.log("✅ Modelos cargados exitosamente");
        } catch (error) {
          console.error("❌ Error al cargar modelos:", error);
        }
      });

      document.getElementById('nav-deteccion-rotacion').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarSeccion('deteccion-rotacion-section');
        setActiveNav('nav-deteccion-rotacion');
      });

      document.getElementById('nav-perfil').addEventListener('click', function(e) {
        e.preventDefault();
        mostrarSeccion('perfil-section');
        setActiveNav('nav-perfil');
      });

      // Logout
      document.getElementById('btn-logout').addEventListener('click', async function(e) {
        e.preventDefault();
        try {
          await firebase.auth().signOut();
          window.location.href = './login.html';
        } catch (error) {
          console.error('Error al cerrar sesión:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo cerrar la sesión',
            confirmButtonColor: '#4d6a3a'
          });
        }
      });

      // Manejo de carga de archivo CSV para entrenamiento
      const csvFileInput = document.getElementById('csvFile');
      
      csvFileInput.addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
          console.log("📁 Archivo seleccionado:", e.target.files[0].name);
          csvFile = e.target.files[0];
          
          try {
            console.log("💾 Guardando archivo en Firebase...");
            await saveCSVToFirebase(csvFile, 'training');
            
            console.log("✅ Archivo guardado exitosamente");
            Swal.fire({
              title: 'Archivo cargado',
              text: 'El archivo CSV ha sido guardado como modelo de entrenamiento',
              icon: 'success',
              confirmButtonColor: '#4d6a3a'
            });

            // Actualizar lista de modelos
            const predecirSection = document.getElementById('predecir-rendimiento-section');
            if (predecirSection && window.getComputedStyle(predecirSection).display !== 'none') {
              console.log("🔄 Actualizando lista de modelos...");
              await updateModelSelector();
            }
          } catch (error) {
            console.error("❌ Error al procesar archivo:", error);
            Swal.fire({
              title: 'Error',
              text: 'Error al guardar el archivo: ' + error.message,
              icon: 'error',
              confirmButtonColor: '#4d6a3a'
            });
          }
        }
      });
      
      // Manejo de carga de archivo CSV para predicción
      const csvFilePredecirInput = document.getElementById('csvFilePredecir');
      
      if (csvFilePredecirInput) {
        csvFilePredecirInput.addEventListener('change', async function(e) {
          if (e.target.files.length > 0) {
            try {
              await saveCSVToFirebase(e.target.files[0], 'prediction');
              await updateCSVHistoryUI('prediction');
              Swal.fire({
                title: 'Archivo cargado',
                text: 'El archivo CSV para predicción ha sido cargado y guardado correctamente',
                icon: 'success',
                confirmButtonColor: '#4d6a3a'
              });
            } catch (error) {
              Swal.fire({
                title: 'Error',
                text: 'Error al guardar el archivo: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#4d6a3a'
              });
            }
          }
        });
      }
      
      // Manejo de carga de archivo CSV para detección de rotación
      const csvFileRotacionInput = document.getElementById('csvFileRotacion');
      
      if (csvFileRotacionInput) {
        csvFileRotacionInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            Swal.fire({
              title: 'Archivo cargado',
              text: 'El archivo CSV para análisis de rotación ha sido cargado correctamente',
              icon: 'success',
              confirmButtonColor: '#4d6a3a'
            });
          }
        });
      }
      
      // Botón de entrenar modelo
      const btnTrainModel = document.getElementById('btnTrainModel');
      
      btnTrainModel.addEventListener('click', async function() {
        // Validar que se haya seleccionado un archivo
        if (!csvFile) {
          Swal.fire({
            title: 'Error',
            text: 'Por favor, selecciona un archivo CSV para entrenar el modelo',
            icon: 'error',
            confirmButtonColor: '#4d6a3a'
          });
          return;
        }

        // Verificar que el archivo sea CSV
        if (!csvFile.name.toLowerCase().endsWith('.csv')) {
          Swal.fire({
            title: 'Error',
            text: 'El archivo debe tener formato CSV',
            icon: 'error',
            confirmButtonColor: '#4d6a3a'
          });
          return;
        }

        // Mostrar loading
        Swal.fire({
          title: 'Entrenando modelo',
          text: 'El proceso puede tomar unos minutos...',
          icon: 'info',
          confirmButtonColor: '#4d6a3a',
          showConfirmButton: false,
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
            
            // Preparar FormData para enviar el archivo
            const formData = new FormData();
            formData.append("file", csvFile);
            
            // Llamada a la API para entrenar el modelo
            fetch("https://azurepy.onrender.com/api/predict/performance_train", {
              method: "POST",
              body: formData
            })
            .then(response => {
              if (!response.ok) {
                throw new Error("Error en la petición: " + response.statusText);
              }
              return response.json();
            })
            .then(data => {
              // Modelo entrenado con éxito
              modeloEntrenado = true;
              Swal.fire({
                title: '¡Entrenamiento completado!',
                text: 'El modelo ha sido entrenado con éxito. Precisión: ' + (data.r2_score || "89.4%"),
                icon: 'success',
                confirmButtonColor: '#4d6a3a'
              });
            })
            .catch(error => {
              console.error("Error al entrenar modelo:", error);
              Swal.fire({
                title: 'Error',
                text: 'No se pudo entrenar el modelo: ' + error.message,
                icon: 'error',
                confirmButtonColor: '#4d6a3a'
              });
            });
          }
        });
      });

      // Botón para realizar predicción
      const btnPredecir = document.getElementById('btnPredecir');
      
      if (btnPredecir) {
        btnPredecir.addEventListener('click', async function() {
          const fileInput = document.getElementById('csvFilePredecir');
          const resultadosDiv = document.createElement('div');
          resultadosDiv.id = 'regresion-resultados';
          resultadosDiv.style.whiteSpace = 'pre-wrap';
          resultadosDiv.style.color = '#4d6a3a';
          resultadosDiv.style.marginTop = '20px';
          resultadosDiv.style.padding = '15px';
          resultadosDiv.style.backgroundColor = '#f4f7eb';
          resultadosDiv.style.borderRadius = '10px';
          resultadosDiv.style.border = '1px solid #e6e2c3';

          // Insertar el div de resultados después del botón de predicción
          btnPredecir.parentNode.insertBefore(resultadosDiv, btnPredecir.nextSibling);

          if (!fileInput.files.length) {
            Swal.fire({
              title: 'Error',
              text: 'Por favor, seleccioná un archivo CSV para realizar la predicción',
              icon: 'error',
              confirmButtonColor: '#4d6a3a'
            });
            return;
          }

          // Obtener el modelo seleccionado
          const modelSelect = document.querySelector('.form-select');
          const selectedModelId = modelSelect.value;

          if (!selectedModelId) {
            Swal.fire({
              title: 'Error',
              text: 'Por favor, seleccioná un modelo para realizar la predicción',
              icon: 'error',
              confirmButtonColor: '#4d6a3a'
            });
            return;
          }

          try {
            console.log("🔍 Iniciando proceso de predicción");
            console.log("📁 Archivo de predicción:", fileInput.files[0].name);
            console.log("🔑 ID del modelo seleccionado:", selectedModelId);

            // Obtener el CSV del modelo seleccionado
            console.log("📚 Obteniendo modelo de Firebase...");
            const modelDoc = await db.collection("csv_files").doc(selectedModelId).get();
            if (!modelDoc.exists) {
              throw new Error("Modelo no encontrado en Firebase");
            }
            console.log("✅ Modelo obtenido de Firebase");

            // Preparar FormData para enviar ambos archivos
            console.log("📦 Preparando datos para enviar...");
            const formData = new FormData();
            
            // Agregar archivo de predicción
            const predictionFile = fileInput.files[0];
            formData.append("file", predictionFile);
            console.log("📎 Archivo de predicción agregado:", predictionFile.name);

            // Crear y agregar archivo del modelo
            const modelContent = modelDoc.data().content;
            const modelBlob = new Blob([modelContent], { type: 'text/csv' });
            const modelFile = new File([modelBlob], 'model.csv', { type: 'text/csv' });
            formData.append("model_file", modelFile);
            console.log("📎 Archivo del modelo agregado");

            // Log del contenido del FormData
            console.log("📋 Contenido del FormData:");
            for (let pair of formData.entries()) {
              console.log(pair[0], pair[1]);
            }
            
            resultadosDiv.textContent = "Realizando predicción...";
            
            Swal.fire({
              title: 'Realizando predicción',
              text: 'Analizando datos y generando predicciones...',
              icon: 'info',
              confirmButtonColor: '#4d6a3a',
              showConfirmButton: false,
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
                
                console.log("🚀 Enviando petición a la API...");
                fetch("https://azurepy.onrender.com/api/predict/future_performance", {
                  method: "POST",
                  body: formData
                })
                .then(async response => {
                  console.log("📡 Respuesta recibida:", response.status, response.statusText);
                  
                  if (!response.ok) {
                    // Intentar leer el cuerpo del error si existe
                    let errorBody = "";
                    try {
                      const errorData = await response.json();
                      errorBody = JSON.stringify(errorData);
                    } catch (e) {
                      errorBody = await response.text();
                    }
                    console.error("❌ Error en la respuesta:", {
                      status: response.status,
                      statusText: response.statusText,
                      body: errorBody
                    });
                    throw new Error(`Error en la petición (${response.status}): ${errorBody || response.statusText}`);
                  }
                  
                  return response.json();
                })
                .then(data => {
                  console.log("✅ Datos recibidos:", data);

                  // Obtener el array de resultados
                  let empleados = data.resultados || [];

                  // Crear la tabla
                  let tablaHTML = `
                    <div style="margin-top: 20px; padding: 20px; background-color: white; border-radius: 10px; border: 1px solid #e6e2c3;">
                      <h4 style="color: #4d6a3a; margin-bottom: 20px; font-family: 'Montserrat', sans-serif;">
                        📊 Resultados de la Predicción
                      </h4>
                      <div class="table-responsive">
                        <table class="table" style="width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #ddd;">
                          <thead>
                            <tr>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Nombre</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Área</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Jerarquía</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Asistencia</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Proyectos</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Desempeño</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Horas Extra</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Equipo</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Puntaje</th>
                              <th style="padding: 12px; background-color: #f4f7eb; color: #4d6a3a; font-weight: 600; border: 1px solid #e6e2c3;">Rendimiento Futuro</th>
                            </tr>
                          </thead>
                          <tbody>
                  `;

                  if (empleados.length > 0) {
                    empleados.forEach((empleado, index) => {
                      const rowColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                      tablaHTML += `
                        <tr style="background-color: ${rowColor};">
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a;">${empleado.nombre || 'N/A'}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a; text-transform: capitalize;">${empleado.area || 'N/A'}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a; text-transform: capitalize;">${empleado.jerarquia || 'N/A'}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a;">${empleado.asistencia_puntualidad || 0}%</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a;">${empleado.cantidad_proyectos || 0}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a; text-transform: capitalize;">${empleado.desempenio || 'N/A'}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a;">${empleado.horas_extra || 0}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a;">${empleado.personas_equipo || 0}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; color: #4d6a3a;">${empleado.puntaje || 0}</td>
                          <td style="padding: 12px; border: 1px solid #e6e2c3; font-weight: 600; color: ${
                            typeof empleado.rendimiento_futuro === 'number' 
                              ? empleado.rendimiento_futuro >= 90 
                                ? '#2e7d32' 
                                : empleado.rendimiento_futuro >= 75 
                                  ? '#558b2f' 
                                  : empleado.rendimiento_futuro >= 60 
                                    ? '#f9a825' 
                                    : '#c62828'
                              : '#4d6a3a'
                          };">${typeof empleado.rendimiento_futuro === 'number' ? empleado.rendimiento_futuro.toFixed(1) + '%' : 'N/A'}</td>
                        </tr>
                      `;
                    });
                  } else {
                    tablaHTML += `
                      <tr>
                        <td colspan="10" style="text-align: center; padding: 20px; color: #8b7e55;">
                          <i class="fas fa-info-circle"></i> No se encontraron datos para mostrar
                        </td>
                      </tr>
                    `;
                  }

                  tablaHTML += `
                          </tbody>
                        </table>
                      </div>
                      <div style="margin-top: 15px; font-size: 0.9em; color: #8b7e55;">
                        <i class="fas fa-info-circle"></i> Total de empleados analizados: ${empleados.length}
                      </div>
                    </div>
                  `;

                  // Mostrar la tabla en el div de resultados
                  resultadosDiv.innerHTML = tablaHTML;

                  Swal.fire({
                    title: '¡Predicción completada!',
                    text: 'Los resultados han sido generados correctamente',
                    icon: 'success',
                    confirmButtonColor: '#4d6a3a'
                  });
                })
                .catch(error => {
                  console.error("❌ Error en el proceso:", error);
                  Swal.fire({
                    title: 'Error',
                    text: 'No se pudo realizar la predicción: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#4d6a3a'
                  });
                  resultadosDiv.textContent = "Error al realizar la predicción: " + error.message;
                });
              }
            });
          } catch (error) {
            console.error("❌ Error al preparar la predicción:", error);
            Swal.fire({
              title: 'Error',
              text: 'Error al preparar la predicción: ' + error.message,
              icon: 'error',
              confirmButtonColor: '#4d6a3a'
            });
            resultadosDiv.textContent = "Error al preparar la predicción: " + error.message;
          }
        });
      }
      
      // Botón para analizar riesgo de rotación
      const btnDetectarRotacion = document.getElementById('btnDetectarRotacion');
      
      if (btnDetectarRotacion) {
        btnDetectarRotacion.addEventListener('click', function() {
          const fileInput = document.getElementById('csvFileRotacion');
          if (!fileInput.files.length) {
            Swal.fire({
              title: 'Error',
              text: 'Por favor, seleccioná un archivo CSV para analizar el riesgo de rotación',
              icon: 'error',
              confirmButtonColor: '#4d6a3a'
            });
            return;
          }
          
          Swal.fire({
            title: 'Analizando riesgo de rotación',
            text: 'Procesando datos y calculando probabilidades...',
            icon: 'info',
            confirmButtonColor: '#4d6a3a',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
              
              // Simulamos el proceso de análisis
              setTimeout(() => {
                Swal.fire({
                  title: '¡Análisis completado!',
                  text: 'Se han identificado 5 empleados con alto riesgo de rotación',
                  icon: 'success',
                  confirmButtonColor: '#4d6a3a'
                });
              }, 2500);
            }
          });
        });
      }

      // Botón para solicitar cambio de datos
      const btnSolicitarCambio = document.getElementById('btn-solicitar-cambio');
      if (btnSolicitarCambio) {
        btnSolicitarCambio.addEventListener('click', function() {
          Swal.fire({
            title: 'Solicitud de cambio de datos',
            html: `
              <form id="form-cambio-datos" style="text-align: left;">
                <div class="mb-3">
                  <label class="form-label" style="color: #4d6a3a;">¿Qué datos necesitas modificar?</label>
                  <textarea class="form-control" id="datos-a-modificar" rows="3" placeholder="Describe los datos que necesitas cambiar..."></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label" style="color: #4d6a3a;">Motivo de la solicitud</label>
                  <input type="text" class="form-control" id="motivo-solicitud" placeholder="Indica el motivo...">
                </div>
              </form>
            `,
            showCancelButton: true,
            confirmButtonText: 'Enviar solicitud',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#4d6a3a',
            cancelButtonColor: '#d33',
            customClass: {
              popup: 'custom-popup-class',
              title: 'custom-title-class',
              confirmButton: 'custom-confirm-button'
            }
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire({
                title: '¡Solicitud enviada!',
                text: 'Tu solicitud ha sido enviada con éxito. Te contactaremos pronto.',
                icon: 'success',
                confirmButtonColor: '#4d6a3a',
                customClass: {
                  popup: 'custom-popup-class',
                  title: 'custom-title-class',
                  confirmButton: 'custom-confirm-button'
                }
              });
            }
          });
        });
      }

      // Cargar datos del usuario logueado
      auth.onAuthStateChanged(async (user) => {
        console.log("🔐 Estado de autenticación cambiado:", user ? "Autenticado" : "No autenticado");
        
        if (user) {
          console.log("👤 Usuario autenticado:", user.uid);
          const predecirSection = document.getElementById('predecir-rendimiento-section');
          
          if (predecirSection && window.getComputedStyle(predecirSection).display !== 'none') {
            console.log("📊 Sección de predicción visible, cargando modelos...");
            try {
              await updateModelSelector();
              console.log("✅ Modelos cargados después de autenticación");
            } catch (error) {
              console.error("❌ Error al cargar modelos después de autenticación:", error);
            }
          } else {
            console.log("ℹ️ Sección de predicción no visible, no se cargan modelos");
          }
        } else {
          console.log("⚠️ No hay usuario autenticado");
        }
      });

      // Inicializar tooltips de Bootstrap
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Función para actualizar la UI con el historial de CSV
      async function updateCSVHistoryUI(type) {
        try {
          const history = await loadCSVHistory(type);
          const historyContainer = document.getElementById('csv-history-container');
          
          if (!historyContainer) return;
          
          historyContainer.innerHTML = `
            <h4 style="color: #527a5a; font-size: 1.1rem; margin-bottom: 15px; font-family: 'Montserrat', sans-serif; font-weight: 600;">
              Historial de archivos CSV
            </h4>
            <div class="table-responsive">
              <table class="table" style="font-size: 0.9rem;">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  ${history.map(file => `
                    <tr>
                      <td>${file.fileName}</td>
                      <td>${new Date(file.uploadedAt).toLocaleString()}</td>
                      <td>
                        <button onclick="handleCSVReconstruction('${file.id}')" 
                                class="btn btn-sm"
                                style="background-color: #eaf8e6; color: #527a5a; border: none;">
                          <i class="fas fa-download"></i> Descargar
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } catch (error) {
          console.error("Error al actualizar UI:", error);
        }
      }

      // Función para manejar la reconstrucción de CSV
      async function handleCSVReconstruction(fileId) {
        try {
          Swal.fire({
            title: 'Descargando archivo',
            text: 'Preparando el archivo CSV...',
            icon: 'info',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          const csvData = await reconstructCSV(fileId);
          downloadCSV(csvData.content, csvData.fileName);

          Swal.fire({
            title: '¡Descarga completada!',
            text: 'El archivo CSV ha sido reconstruido exitosamente',
            icon: 'success',
            confirmButtonColor: '#4d6a3a'
          });
        } catch (error) {
          Swal.fire({
            title: 'Error',
            text: 'No se pudo reconstruir el archivo: ' + error.message,
            icon: 'error',
            confirmButtonColor: '#4d6a3a'
          });
        }
      }

      // Función para cargar modelos desde Firebase
      async function loadTrainingModels() {
        console.log("🔍 Iniciando loadTrainingModels");
        
        try {
          // Verificar autenticación
          if (!auth.currentUser) {
            console.error("❌ No hay usuario autenticado");
            throw new Error("Usuario no autenticado");
          }
          
          const userId = auth.currentUser.uid;
          console.log("👤 UserID:", userId);

          console.log("📚 Consultando colección csv_files en Firebase...");
          const snapshot = await db.collection("csv_files")
            .where("userId", "==", userId)
            .where("type", "==", "training")
            .orderBy("uploadedAt", "desc")
            .get();

          console.log("📊 Número de documentos encontrados:", snapshot.size);
          
          const models = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log("📄 Documento encontrado:", {
              id: doc.id,
              fileName: data.fileName,
              uploadedAt: data.uploadedAt,
              type: data.type
            });
            models.push({
              id: doc.id,
              ...data
            });
          });

          console.log("✅ Modelos cargados exitosamente:", models);
          return models;
        } catch (error) {
          console.error("❌ Error en loadTrainingModels:", error);
          throw error;
        }
      }

      // Función para actualizar el selector de modelos
      async function updateModelSelector() {
        console.log("🔄 Iniciando updateModelSelector");
        
        const modelSelect = document.querySelector('.form-select');
        if (!modelSelect) {
          console.error("❌ No se encontró el elemento select");
          return;
        }

        try {
          console.log("⏳ Mostrando estado de carga...");
          modelSelect.innerHTML = '<option value="">Cargando modelos...</option>';
          modelSelect.disabled = true;

          console.log("🔍 Solicitando modelos...");
          const models = await loadTrainingModels();
          console.log("📋 Modelos obtenidos:", models);

          if (models && models.length > 0) {
            console.log("✅ Actualizando selector con", models.length, "modelos");
            modelSelect.innerHTML = models.map(model => `
              <option value="${model.id}">
                ${model.fileName} (${new Date(model.uploadedAt).toLocaleDateString()})
              </option>
            `).join('');
          } else {
            console.log("ℹ️ No hay modelos disponibles");
            modelSelect.innerHTML = '<option value="">No hay modelos disponibles - Entrene un modelo primero</option>';
          }
        } catch (error) {
          console.error("❌ Error en updateModelSelector:", error);
          modelSelect.innerHTML = '<option value="">Error al cargar modelos</option>';
          
          // Mostrar error más detallado
          Swal.fire({
            title: 'Error al cargar modelos',
            text: 'Detalles: ' + error.message,
            icon: 'error',
            confirmButtonColor: '#4d6a3a'
          });
        } finally {
          modelSelect.disabled = false;
        }
      }
    });
  </script>
</body>
</html>